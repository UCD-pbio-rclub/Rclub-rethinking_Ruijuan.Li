---
title: "Assignment-09-assignment"
author: "Ruijuan Li"
date: "August 22, 2016"
output: html_document
---
# In class solving of the tomato problem
# Aug 2, 2016
# By: Julin, Nicole, Gina, Ruijuan, Xiaoyan, Jessica, Emily

```{r}
# Do a Bayesian analysis of hypocotyl length (hyp) in the attached data sheet.
# 
# 1) Does the best model include species, trt, or both?
# 
# 2) Evaluate the hypothesis that trt has an effect on hypocotyl length
# 
# If you get stuck early, don't worry, come anyway abd we can work on it in R Club
```

```{r}
setwd("~/Desktop/2016_summer/R_club/Assignment_Chapter_09")

# load the data and libraries
data <- read.csv("TomatoR2CSHL.csv")

library(rethinking)
library(ggplot2)
library(reshape2)

# take a look at the data
head(data)
summary(data)

# density plots
pl <- ggplot(data=data,aes(x=hyp,fill=trt))
pl <- pl + geom_density()
pl <- pl + facet_grid(species ~ trt)
pl

# box plots
pl <- ggplot(data=data,aes(y=hyp,x=species,fill=trt))
pl <- pl + geom_boxplot()
pl

# log2 transformation
pl <- ggplot(data=data,aes(x=log2(hyp),fill=trt))
pl <- pl + geom_density()
pl <- pl + facet_grid(species ~ trt)
pl + ggtitle("log2 transformed")

# Square root transformation
pl <- ggplot(data=data,aes(x=sqrt(hyp),fill=trt))
pl <- pl + geom_density()
pl <- pl + facet_grid(species ~ trt)
pl + ggtitle("sqrt transformed")

#normality test
by(data$hyp,list(data$trt,data$species),shapiro.test) # seperate normality test for each sampling. 
by(sqrt(data$hyp),list(data$trt,data$species),shapiro.test)
by(log2(data$hyp),list(data$trt,data$species),shapiro.test)
#sqrt transformed is best

# categorical variable for trt
data$trtL <- ifelse(data$trt=="L",1,0)

# alternative way
levels(data$trt)
data$trt2 <- as.numeric(data$trt)-1 # 0 = H, 1 = L

identical(data$trt2, data$trtL) # the two methods produce the same result. 

#categorical variables for species
# data2 <- dcast(data,index + hyp + trt2 ~ species, value.var="species",fun.aggregate=length)
# ?dcast
# head(data2)
# tail(data2) # some missing data??? 

#must subset the data frame to contain only the relevant columns
data.trt <- data[,c("hyp","trt2")]

head(data.trt)
data.trt

# trt model
hyp.stan <- map2stan(alist(
  hyp ~ dnorm(mu,sigma),
  mu <- a + bT * trt2,
  a ~ dnorm(0,100),
  bT ~ dnorm(0,10),
  sigma ~ dunif(0,20)),
  data.trt,
  chains = 4)

plot(hyp.stan)
precis(hyp.stan)
par(mfrow=c(1,1),mfcol=c(1,1))
plot(precis(hyp.stan))

head(data)

# fit a model with species 
data.species <- data[,c("hyp","species")]
data.species$id <- 1:nrow(data.species)
data.species <- dcast(data.species, hyp + id ~ species, value.var="species", fun.aggregate = length)
colnames(data.species) <- sub(". ","_",fixed = TRUE, colnames(data.species))
head(data.species)
data.species <- data.species[,c(-2)]

species.stan <- map2stan(alist(
  hyp ~ dnorm(mu,sigma),
  mu <- bChil*S_chilense + bChmi*S_chmielewskii + bHab*S_habrochaites + bPen * S_pennellii + bPer*S_peruvianum,
  c(bChil,bChmi,bHab,bPen,bPer) ~ dnorm(33.35,20),
  sigma ~ dunif(0,20)),
  data.species,
  chains = 4)

plot(species.stan)
precis(species.stan)
par(mfrow=c(1,1),mfcol=c(1,1))
plot(precis(species.stan))

# model with species and treatment

head(data)
data.species.trt <- data[,c("hyp", "species", "trt")]

head(data.species.trt)
data.species.trt$id <- 1:nrow(data.species.trt)
data.species.trt <- dcast(data.species.trt, hyp + trt + id ~ species, value.var="species", fun.aggregate = length)
data.species.trt <- data.species.trt[,c(-3)]
data.species.trt$trt <- as.numeric(data.species.trt$trt)-1
colnames(data.species.trt) <- sub(". ","_",fixed = TRUE, colnames(data.species.trt))
head(data.species.trt)

species.trt.stan <- map2stan(alist(
  hyp ~ dnorm(mu,sigma),
  mu <- a + bT*trt + bChil*S_chilense + bHab*S_habrochaites + bPen * S_pennellii + bPer*S_peruvianum,
  a ~ dnorm(33.35,10),
  c(bT,bChil,bHab,bPen,bPer) ~ dnorm(0,10),
  sigma ~ dunif(0,20)),
  data.species.trt,
  chains = 4)

plot(species.trt.stan)
precis(species.trt.stan)
par(mfrow=c(1,1),mfcol=c(1,1))
plot(precis(species.trt.stan))

#compare models

compare(hyp.stan,species.trt.stan,species.stan)
plot(compare(hyp.stan,species.trt.stan,species.stan))

coeftab(hyp.stan,species.trt.stan,species.stan)

plot(coeftab(hyp.stan,species.trt.stan,species.stan))

# what can we say about the treatment effect? 

# get the posterior distrubution of bT, the treatment coefficient.

post.bT <- extract.samples(species.trt.stan)$bT

dens(post.bT,show.HPDI = 0.95) # the fact that the 95% HDPI intervals are far away from 0 is strong evidence that bT is positive

# what percent of the posterior distribution of bT is less than or equal to ?
sum(post.bT <= 0) / length(post.bT) # None of the posterior distribution for bT is less than or equal to 0.
```

# try sqrt transformation 
```{r}
# sqrt transformation 
data$hyp_sqrt <- sqrt(data$hyp)
head(data)

# only trt 
# categorical variable for trt
data$trt2 <- ifelse(data$trt=="L",1,0)

#must subset the data frame to contain only the relevant columns
data.trt.sqrt <- data[,c("hyp_sqrt","trt2")]

head(data.trt.sqrt)
data.trt.sqrt

mean(data.trt.sqrt$hyp_sqrt)
# trt model
hyp.stan.sqrt <- map2stan(alist(
  hyp ~ dnorm(mu,sigma),
  mu <- a + bT * trt2,
  a ~ dnorm(5.7,100), # forget how to get an estimate of these start values??? 
  bT ~ dnorm(0,10), # and this
  sigma ~ dunif(0,20)), # and this... 
  data.trt.sqrt,
  chains = 4)

plot(hyp.stan)
precis(hyp.stan.sqrt)
par(mfrow=c(1,1),mfcol=c(1,1))
plot(precis(hyp.stan))

head(data)

# species model 
# fit a model with species 
data.species.sqrt <- data[,c("hyp","species")]
data.species.sqrt$id <- 1:nrow(data.species.sqrt)
data.species.sqrt <- dcast(data.species.sqrt, hyp + id ~ species, value.var="species", fun.aggregate = length)
colnames(data.species.sqrt) <- sub(". ","_",fixed = TRUE, colnames(data.species.sqrt))
head(data.species.sqrt)
data.species.sqrt$hyp_sqrt <- sqrt(data.species.sqrt$hyp)
head(data.species.sqrt)
data.species.sqrt <- data.species.sqrt[,c(-1,-2)]

species.stan.sqrt <- map2stan(alist(
  hyp ~ dnorm(mu,sigma),
  mu <- bChil*S_chilense + bChmi*S_chmielewskii + bHab*S_habrochaites + bPen * S_pennellii + bPer*S_peruvianum,
  c(bChil,bChmi,bHab,bPen,bPer) ~ dnorm(33.35,20),
  sigma ~ dunif(0,20)),
  data.species.sqrt,
  chains = 4)

plot(species.stan)
precis(species.stan)
par(mfrow=c(1,1),mfcol=c(1,1))
plot(precis(species.stan))






```


